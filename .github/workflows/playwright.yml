name: Playwright Tests with Allure and Lighthouse

on:
  schedule:
    - cron: '0 8 * * *'  # Runs daily at 08:00 UTC
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    name: Run Playwright tests with 3 shards
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2, 3]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run tests on shard ${{ matrix.shard }}
        run: |
          npx playwright test --shard=${{ matrix.shard }}/3 \
            --reporter=dot,line,allure-playwright

      - name: Verify Allure results exist
        run: |
          if [ ! -d "./allure-results" ] || [ -z "$(ls -A ./allure-results)" ]; then
            echo "âŒ No Allure results found for shard ${{ matrix.shard }}"
            exit 1
          fi

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-shard-${{ matrix.shard }}
          path: ./allure-results

  audit-performance:
    name: Run Lighthouse Audit
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Lighthouse
        run: npm install -g lighthouse

      - name: Create Lighthouse directory
        run: mkdir -p ./lighthouse

      - name: Check site availability
        run: |
          curl -s --head https://suprimaaldino.github.io/cdcplaywrightlocator/ | head -n 1 | grep "200 OK" || {
            echo "ğŸš« Site not reachable, skipping Lighthouse audit."
            exit 1
          }

      - name: Retry Lighthouse audit (max 3x)
        run: |
          ATTEMPT=0
          until [ $ATTEMPT -ge 3 ]; do
            echo "ğŸ” Attempt $((ATTEMPT+1))..."
            npx lighthouse https://suprimaaldino.github.io/cdcplaywrightlocator/ \
              --output=json,html \
              --output-path=./lighthouse/lighthouse-report \
              --chrome-flags="--headless" \
              --preset=desktop \
              --disable-gatherers=Interactive && break
            ATTEMPT=$((ATTEMPT+1))
            sleep 5
          done

      - name: Verify Lighthouse report generated
        run: |
          if [ ! -f "./lighthouse/lighthouse-report.html" ]; then
            echo "âš ï¸ Lighthouse report failed to generate."
            exit 1
          else
            echo "âœ… Lighthouse report generated successfully."
            ls -la ./lighthouse/
          fi

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: ./lighthouse
          if-no-files-found: warn

  merge-allure-reports:
    name: Merge Allure Reports and Deploy
    runs-on: ubuntu-latest
    needs: [test, audit-performance]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Allure CLI
        run: npm install -g allure-commandline@2.24.0

      - name: Clean old results and reports
        run: rm -rf ./allure-results ./allure-report ./lighthouse

      - name: Backup previous Allure report
        run: |
          if [ -d "./allure-report" ]; then
            echo "Backing up previous report..."
            mv ./allure-report ./allure-report-backup
          fi

      - name: Download Allure results from all shards
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-shard-*
          merge-multiple: true
          path: ./allure-results

      - name: Download Lighthouse report
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-report
          path: ./lighthouse
        if: success() || failure()

      - name: Check Lighthouse report existence
        id: check_lighthouse
        run: |
          if [ -f "./lighthouse/lighthouse-report.html" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Allure report
        run: |
          if [ ! -d "./allure-results" ] || [ -z "$(ls -A ./allure-results)" ]; then
            echo "âŒ No Allure results found!"
            if [ -d "./allure-report-backup" ]; then
              echo "ğŸ” Rolling back to previous report..."
              mv ./allure-report-backup ./allure-report
              exit 0
            else
              echo "ğŸš« No backup available. Cannot generate report."
              exit 1
            fi
          fi
          echo "ğŸ› ï¸ Generating Allure report..."
          allure generate ./allure-results --clean -o ./allure-report

      - name: Embed Lighthouse report into Allure
        if: steps.check_lighthouse.outputs.report_exists == 'true'
        run: |
          mkdir -p ./allure-report/lighthouse
          cp ./lighthouse/lighthouse-report.html ./allure-report/lighthouse/
          echo "ğŸ“ Lighthouse report embedded."

      - name: Upload Allure report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: ./allure-report

      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          keep_files: false
          force_orphan: false

      - name: Notify Telegram of CI completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… *Playwright tests passed* ğŸ§ª"
          elif [ -d "./allure-report-backup" ] && [ ! -d "./allure-results" ]; then
            STATUS="âš ï¸ *Tests failed â€” rolled back to previous report* ğŸ”"
          else
            STATUS="âŒ *Playwright tests failed* ğŸ’¥"
          fi

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          REPORT_URL="https://suprimaaldino.github.io/cdcplaywrightlocator/"

          MESSAGE=$(cat <<EOF
          $STATUS

          ğŸ•‘ Completed at: $TIMESTAMP  
          ğŸ“Š [View Allure Report]($REPORT_URL)  
          ğŸ” Lighthouse audit included in /lighthouse/
          EOF
          )

          echo "Sending Telegram notification..."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=$MESSAGE"

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: merge-allure-reports
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate changelog
        id: changelog
        uses: TriPSs/conventional-changelog-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-file: CHANGELOG.md
          skip-version-file: true
          skip-commit: true
          skip-tag: true

      - name: Commit updated changelog
        run: |
          git config user.name "CI Bot"
          git config user.email "ci@bot.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog [skip ci]"
          git push